pipeline {
    agent any

    environment {
        VENV_DIR = "venv"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Set up Python') {
            steps {
                sh 'python3 -m venv ${VENV_DIR} || python -m venv ${VENV_DIR}'
                sh '. ${VENV_DIR}/bin/activate && pip install --upgrade pip'
            }
        }

        stage('Install dependencies') {
            steps {
                sh '. ${VENV_DIR}/bin/activate && pip install -r requirements.txt'
            }
        }

        stage('Restart Flask app (pm2)') {
            steps {
                // assumes pm2 ecosystem config or named process 'flask-app'
                sh 'pm2 start \"gunicorn -b 0.0.0.0:5000 app:app\" --name flask-app || pm2 restart flask-app'
                sh 'pm2 save'
            }
        }
    }
}

